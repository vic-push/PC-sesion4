bbe1e466016a7ed48f546f8995ee5cae
const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');
const location = process.env.SQLITE_DB_LOCATION || '/tmp/todo.db';
let db, dbAll, dbRun;
function init() {
  const dirName = require('path').dirname(location);
  if (!fs.existsSync(dirName)) {
    fs.mkdirSync(dirName, {
      recursive: true
    });
  }
  return new Promise((acc, rej) => {
    db = new sqlite3.Database(location, err => {
      if (err) return rej(err);
      if (process.env.NODE_ENV !== 'test') console.log(`Using sqlite database at ${location}`);
      db.run('CREATE TABLE IF NOT EXISTS todo_items (id varchar(36), name varchar(255), completed boolean)', (err, result) => {
        if (err) return rej(err);
        acc();
      });
    });
  });
}
async function teardown() {
  return new Promise((acc, rej) => {
    db.close(err => {
      if (err) rej(err);else acc();
    });
  });
}
async function getItems() {
  return new Promise((acc, rej) => {
    db.all('SELECT * FROM todo_items', (err, rows) => {
      if (err) return rej(err);
      acc(rows.map(item => Object.assign({}, item, {
        completed: item.completed === 1
      })));
    });
  });
}
async function getItem(id) {
  return new Promise((acc, rej) => {
    db.all('SELECT * FROM todo_items WHERE id=?', [id], (err, rows) => {
      if (err) return rej(err);
      acc(rows.map(item => Object.assign({}, item, {
        completed: item.completed === 1
      }))[0]);
    });
  });
}
async function storeItem(item) {
  return new Promise((acc, rej) => {
    db.run('INSERT INTO todo_items (id, name, completed) VALUES (?, ?, ?)', [item.id, item.name, item.completed ? 1 : 0], err => {
      if (err) return rej(err);
      acc();
    });
  });
}
async function updateItem(id, item) {
  return new Promise((acc, rej) => {
    db.run('UPDATE todo_items SET name=?, completed=? WHERE id = ?', [item.name, item.completed ? 1 : 0, id], err => {
      if (err) return rej(err);
      acc();
    });
  });
}
async function removeItem(id) {
  return new Promise((acc, rej) => {
    db.run('DELETE FROM todo_items WHERE id = ?', [id], err => {
      if (err) return rej(err);
      acc();
    });
  });
}
module.exports = {
  init,
  teardown,
  getItems,
  getItem,
  storeItem,
  updateItem,
  removeItem
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzcWxpdGUzIiwicmVxdWlyZSIsInZlcmJvc2UiLCJmcyIsImxvY2F0aW9uIiwicHJvY2VzcyIsImVudiIsIlNRTElURV9EQl9MT0NBVElPTiIsImRiIiwiZGJBbGwiLCJkYlJ1biIsImluaXQiLCJkaXJOYW1lIiwiZGlybmFtZSIsImV4aXN0c1N5bmMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJQcm9taXNlIiwiYWNjIiwicmVqIiwiRGF0YWJhc2UiLCJlcnIiLCJOT0RFX0VOViIsImNvbnNvbGUiLCJsb2ciLCJydW4iLCJyZXN1bHQiLCJ0ZWFyZG93biIsImNsb3NlIiwiZ2V0SXRlbXMiLCJhbGwiLCJyb3dzIiwibWFwIiwiaXRlbSIsIk9iamVjdCIsImFzc2lnbiIsImNvbXBsZXRlZCIsImdldEl0ZW0iLCJpZCIsInN0b3JlSXRlbSIsIm5hbWUiLCJ1cGRhdGVJdGVtIiwicmVtb3ZlSXRlbSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJzcWxpdGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc3FsaXRlMyA9IHJlcXVpcmUoJ3NxbGl0ZTMnKS52ZXJib3NlKCk7XG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBsb2NhdGlvbiA9IHByb2Nlc3MuZW52LlNRTElURV9EQl9MT0NBVElPTiB8fCAnL3RtcC90b2RvLmRiJztcblxubGV0IGRiLCBkYkFsbCwgZGJSdW47XG5cbmZ1bmN0aW9uIGluaXQoKSB7XG4gICAgY29uc3QgZGlyTmFtZSA9IHJlcXVpcmUoJ3BhdGgnKS5kaXJuYW1lKGxvY2F0aW9uKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGlyTmFtZSkpIHtcbiAgICAgICAgZnMubWtkaXJTeW5jKGRpck5hbWUsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoYWNjLCByZWopID0+IHtcbiAgICAgICAgZGIgPSBuZXcgc3FsaXRlMy5EYXRhYmFzZShsb2NhdGlvbiwgZXJyID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWooZXJyKTtcblxuICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAndGVzdCcpXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFVzaW5nIHNxbGl0ZSBkYXRhYmFzZSBhdCAke2xvY2F0aW9ufWApO1xuXG4gICAgICAgICAgICBkYi5ydW4oXG4gICAgICAgICAgICAgICAgJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHRvZG9faXRlbXMgKGlkIHZhcmNoYXIoMzYpLCBuYW1lIHZhcmNoYXIoMjU1KSwgY29tcGxldGVkIGJvb2xlYW4pJyxcbiAgICAgICAgICAgICAgICAoZXJyLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlaihlcnIpO1xuICAgICAgICAgICAgICAgICAgICBhY2MoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRlYXJkb3duKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoYWNjLCByZWopID0+IHtcbiAgICAgICAgZGIuY2xvc2UoZXJyID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHJlaihlcnIpO1xuICAgICAgICAgICAgZWxzZSBhY2MoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEl0ZW1zKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoYWNjLCByZWopID0+IHtcbiAgICAgICAgZGIuYWxsKCdTRUxFQ1QgKiBGUk9NIHRvZG9faXRlbXMnLCAoZXJyLCByb3dzKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqKGVycik7XG4gICAgICAgICAgICBhY2MoXG4gICAgICAgICAgICAgICAgcm93cy5tYXAoaXRlbSA9PlxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBpdGVtLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZWQ6IGl0ZW0uY29tcGxldGVkID09PSAxLFxuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEl0ZW0oaWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKGFjYywgcmVqKSA9PiB7XG4gICAgICAgIGRiLmFsbCgnU0VMRUNUICogRlJPTSB0b2RvX2l0ZW1zIFdIRVJFIGlkPT8nLCBbaWRdLCAoZXJyLCByb3dzKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqKGVycik7XG4gICAgICAgICAgICBhY2MoXG4gICAgICAgICAgICAgICAgcm93cy5tYXAoaXRlbSA9PlxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBpdGVtLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZWQ6IGl0ZW0uY29tcGxldGVkID09PSAxLFxuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICApWzBdLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0b3JlSXRlbShpdGVtKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChhY2MsIHJlaikgPT4ge1xuICAgICAgICBkYi5ydW4oXG4gICAgICAgICAgICAnSU5TRVJUIElOVE8gdG9kb19pdGVtcyAoaWQsIG5hbWUsIGNvbXBsZXRlZCkgVkFMVUVTICg/LCA/LCA/KScsXG4gICAgICAgICAgICBbaXRlbS5pZCwgaXRlbS5uYW1lLCBpdGVtLmNvbXBsZXRlZCA/IDEgOiAwXSxcbiAgICAgICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlaihlcnIpO1xuICAgICAgICAgICAgICAgIGFjYygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlSXRlbShpZCwgaXRlbSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoYWNjLCByZWopID0+IHtcbiAgICAgICAgZGIucnVuKFxuICAgICAgICAgICAgJ1VQREFURSB0b2RvX2l0ZW1zIFNFVCBuYW1lPT8sIGNvbXBsZXRlZD0/IFdIRVJFIGlkID0gPycsXG4gICAgICAgICAgICBbaXRlbS5uYW1lLCBpdGVtLmNvbXBsZXRlZCA/IDEgOiAwLCBpZF0sXG4gICAgICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWooZXJyKTtcbiAgICAgICAgICAgICAgICBhY2MoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgfSk7XG59IFxuXG5hc3luYyBmdW5jdGlvbiByZW1vdmVJdGVtKGlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChhY2MsIHJlaikgPT4ge1xuICAgICAgICBkYi5ydW4oJ0RFTEVURSBGUk9NIHRvZG9faXRlbXMgV0hFUkUgaWQgPSA/JywgW2lkXSwgZXJyID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWooZXJyKTtcbiAgICAgICAgICAgIGFjYygpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgaW5pdCxcbiAgICB0ZWFyZG93bixcbiAgICBnZXRJdGVtcyxcbiAgICBnZXRJdGVtLFxuICAgIHN0b3JlSXRlbSxcbiAgICB1cGRhdGVJdGVtLFxuICAgIHJlbW92ZUl0ZW0sXG59O1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQ0MsT0FBTyxDQUFDLENBQUM7QUFDNUMsTUFBTUMsRUFBRSxHQUFHRixPQUFPLENBQUMsSUFB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